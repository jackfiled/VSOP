# 基于Arduino的开源手机设计
# 实验报告

***

>[代码仓库地址](https://gitee.com/ricardo-ren/vsop)  
>本篇文档采用Markdown编写  

## 实验设计
实验的总体目标是设计一个简单的非智能机操作系统。在设计时，这个操作系统应能提供显示，连接WiFi，展示时间等的基本功能，可以使用开发板上的多种传感器，与GPRS芯片正常通信来使用相关的功能，并且构建一系列通用的函数来时后续的应用程序可以方便的使用操作系统提供的相关功能。    

***

## 设计思路
首先是跟随着课程的进度，逐个验证相关模块的知识与可行性。  
在这期间被验证的模块有：显示屏的使用，计步器的使用，通过软串口与GPRS芯片通信的部分，对于键盘的使用，WiFi部分的使用等等。  
在了解了以上模块的相关知识和实际使用过之后，正式开始设计整个程序。   
我首先设计的是计步器与键盘这两个传感器的相关函数。这两个传感器都具有着相同的特点，他们在是使用前被需要初始化，于是我设计了相关的初始化函数，他们都是需要在程序的主循环中反复调用的函数，于是我分别设计了一个函数，计步器的轮询函数会返回当前已经行走了的步数，按键的轮询函数会返回当前按下的键（在没有键按下的情况下的返回值是字符'F'，这个值在我的程序中是相当重要的一个值）。   
由于键盘上只有阿拉伯数字的输入，我又设计了一个函数用于实现拉丁字母的输入，使用一个二维数组来存储所有的字母，大数组里面是九个小数组，对应键盘上的九个数字键，通过两次按键来输入一个字母，虽然输入的效率有一点低，但是在这样一个功能比较有限的手机已经十分有用了。   
显示屏相关的函数。这里我没有使用课程中使用的TFT_eSPI这个库，可能由于PlatformIO中下载的库版本问题，我使用这个库可能会导致Arduino反复重启，在串口中可以发现重启的”rst cause“是2，查阅相关手册得知这是外部复位或者是是睡眠(deep slepp)醒来，在网络着多方搜集资料无果后，通过排除法验证时这个库引发的问题，于是使用Adafruit_GFX这个库代替之。在深入研究了相关的显示库函数之后，我只抽象出了两个函数，清屏与显示一段文字的函数。抽象出这两个函数是因为我认为这两个函数很容易被复用。而且在代码中我是采用了自己抽象的函数与相关的库函数混合使用的方式来编写代码，这样可以最大程度的保证代码的简洁性与显示时的灵活性。   
与网络连接有关的函数。这些函数包括，一个扫描环境中WiFi的函数，一个连接指定WiFi的函数，以及一个实验性质的通过校园网认证的函数，但是这个函数在实际测试被证明是失败的。   
在编写好上述的工具函数后，我开始编写操作系统的操作界面。我总体的设计方向是每一个界面都是一个独立的函数，在界面中跳转就是在函数之间的相互调用，这样也可以方便地返回上一个界面。而且每一个函数都具有近似的结构，主体都是反复读取键盘的输入，通过switch语句实现对于不同输入的反馈。   
基于上述的思路，我成功的设计了主界面，设置界面，连接WiFi界面，计步器界面，控制串口界面等等界面函数，并且设置的相应的按键使它们之间可以相互跳转。   

***

## 业务逻辑
首先给出代码中所有的函数原型
```C
char inputLetter(void);
void callback(char *topic, byte *payload, int length);
void reconnect(void);
void cleanScreen(void);
void printText(String text, int x, int y);
bool scan_wifi();
int connect_wifi(const char *ssid, const char *pass);
int login_school_network();
void counter_setup(void);
int counter_run(void);
void keyPadSetUp(void);
char getKeyPressed(void);
uint32_t get_time(void);
void mainMenu(void);
void wifiMenu(void);
void walkCounter(void);
void air202(void);
```
第一个函数inputLetter函数是一个实现字母输入功能的函数。当调用该函数时，会创建一个新的页面，按下一个数字键屏幕上会出现三个字母以供选择，再按下一个按键，从三个给出的字母中选择一个，函数结束，返回选择的字母。  
第二个callback与第三个reconnect都是mqtt的回调函数，负责处理收到消息与重新连接服务器。   
第四个函数时清屏函数，通过将整个屏幕填充为白色来实现清屏。   
第五个函数时打印字符串函数，通过调用库函数来实现，可以指定文字显示的位置，同时修改函数中的字体大小值可以设定全局的字体大小。   
第六个函数时scan_wifi是扫描环境中WiFi的函数，扫描WiFi的结果会直接写入全局的字符串数组中，由于受屏幕大小的限制，只存储了6条WiFi的信息。   
第七个函数connect_wifi是连接WiFi的函数，该函数接受与连接WiFi的名字与密码，连接成功返回0，否则返回-1。   
第八个函数是尝试登录校园网的函数，利用http功能给校园网的认证服务器发送一条post信息，但是并没有成功。   
接下来的两个函数是计步器的初始化与计步器的计步函数。其中计步函数会返回当前所走的步数，如果需要就接受，若不需要直接调用即可。  
下面的两个函数是键盘的初始化函数和获取当前按键的函数。其中获取按键函数会返回当前按下的键盘，如果没有按键被按下则返回F。   
下面是还未完成的时间同步函数，该函数通过与远程的服务器建立tcp连接来获取当前的时间。   
剩下的四个函数都是界面函数，他们的结构与loop函数一样，都是
```C
void functionName(void)
{
    int input = 'F';
    bool flag = false;
    //初始化变量
    cleanScreen();

    //主循环
    while (input == 'F')
    {
        input = getKeyPressed();
        //获取当前的按键
        //用switch语句处理输入
        switch (input)
        {
        case '1':
            
            break;
        case '2':

            break;
        case '#':
            
            break;
        }
        counter_run();
        delay(100);
        input = 'F';
    }
}
```
mainMenu函数负责显示操作系统的设置界面，WiFiMenu负责连接WiFi的功能， walkCounter负责显示计步器的画面，air202是显示控制GPRS芯片界面的函数。  

***

## 设计中所遇到的问题
### TFT_eSPI库所导致的无限重启问题
在我第一次在几个大的模块整合在一起运行时，我遇到了Arduino无限重启的问题。具体的表现为屏幕无显示，在串口设置为115200的条件下可以收到Arduino所发送的重启信息，其中标记的重启信息（rst cause）为2，经查阅相关的资料后得知，这个数字代表的意义是外部复位或者deep sleep醒来。首先我测试了最简单的blink函数，确认开发板的硬件功能基本正常，然后我将几个模块拆开来分别运行，确认每个模块都运行正常。但是在将几个模块合并在一起之后，诡异的重启问题又出现了。在几经查找资料无果之后，我才用排除法，每次注释掉一个模块的调用，找出出问题的那个模块。在我删除显示部分后，工作正常了。于是我便决定更换显示库，从TFT_eSPI换位Adafruit_GFX，在更换之后，问题便没有在出现过。   

### 代码规范
在刚刚开始整合几个模块时，我所有的变量都是设置的全局变量，并且变量的名称设置还趋于简单，导致在编写程序时中几个不同的函数使用的几个意义相近的变量经常混淆。在连续几次编译报警告之后，我决定重构了整个代码，并且为每一个变量设置了合适的作用域。在之后的编程中也尽量多写注释，争取使每一个变量的命名都言之有物，同时代码的结构也比较的清晰。这是我第一次写行数的比较长的C语言代码，这次的经历也让我认识到了优秀的代码风格对于程序编写的好处。

***

## 实验的心得与体会
本次实验是我第一次进行较为大型的硬件开发，第一次体验到了直接编程控制硬件与编写软件之间的差异，也是我第一次用C语言编写比较大规模的实战项目。我首先感受到了硬件开发的不易，相较于软件开发的测试方便与简洁，硬件开发时必须将代码编译烧写进开发板，每每修改一个bug就要反复烧写好几次，在一定程度上降低了开发效率，而且在硬件开发时大部分情况下不会有调试这种“高级”玩意儿，只能将所有的变量的值通过串口打印出来。第二我感到了git在版本管理中的好处，在你修改了代码导致了不好的后果之后，可以很简单的找回你之前写的可以正常运行的代码。  
